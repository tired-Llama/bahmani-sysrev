```{r}
df_meta <- df_all
# df_meta$other.grouping[31] <- "(CNN) based on the\nVoxception-ResNet"
df_diag <- df_meta  %>% 
    mutate(DP = TP+FN, DN = FP+TN) %>% 
    select(c(Study.ID,lesions,AI_model,other.grouping,TP,FN,FP,TN,DP,DN,modality,dataset)) %>% 
    drop_na (TP)  %>% 
    drop_na(TN)

sensetivity <- meta::metaprop(
    data = df_diag,
    event = TP,
    n = DP,
    subgroup = dataset,
    sm = "PRAW",
    studlab = Study.ID,
    common = FALSE,
    random = TRUE,
    title = "sensetivity",
    outclab = "Sensetivity",
    pscale = 100
)
# summary(sensetivity)

specificity <- meta::metaprop(
    data = df_diag,
    event = TN,
    n = DN,
    sm = "PRAW",
    subgroup = dataset,
    studlab = Study.ID,
    common = FALSE,
    random = TRUE,
    title = "Specificity",
    outclab = "Specificity",
    pscale = 100
)

# summary(specificity)
```

```{r table_for_forestplot}
df_plot <- data.frame(
    Study = sensetivity$studlab,
    sen = sensetivity$TE,
    sen_low = sensetivity$lower,
    sen_hi = sensetivity$upper,
    Sensetivity = paste(rep(" ",15),collapse = " "),
    spe = specificity$TE,
    spe_low = specificity$lower,
    spe_hi = specificity$upper,
    Specificity = paste(rep(" ",15),collapse = " ")
)

df_plot$"Sensetivity (95%CI)" <- sprintf("%.2f (%.2f - %.2f)", sensetivity$TE*100, sensetivity$lower*100, sensetivity$upper*100)
df_plot$"Weight" <- round(sensetivity$w.random*100/sum(sensetivity$w.random),1)
df_plot$"Specificity (95%CI)" <- sprintf("%.2f (%.2f - %.2f)", specificity$TE*100, specificity$lower*100, specificity$upper*100)
df_plot$" Weight" <- round(specificity$w.random*100/sum(specificity$w.random),1)
df_plot$"AI model" <- ifelse(is.na(df_diag$other.grouping),"",df_diag$other.grouping)
df_plot$lesion <- df_diag$lesions
df_plot$modality <- df_diag$modality
df_plot$dataset <- sensetivity$subgroup
```
```{r subgroup_rows}
df_sgp <- data.frame(
    row.names = c(1:3), 
    Study = c("training","validation","test"),
    sen=sensetivity$TE.random.w,
    sen_low=sensetivity$lower.random.w,
    sen_hi=sensetivity$upper.random.w,
    Sensetivity = paste(rep(" ",15),collapse = " "),
    spe=specificity$TE.random.w,
    spe_low=specificity$lower.random.w,
    spe_hi=specificity$upper.random.w,
    Specificity = paste(rep(" ",15),collapse = " ")
)

df_sgp$"Sensetivity (95%CI)" <- sprintf("%.2f (%.2f - %.2f)\n I^2 = %.2f (%.2f - %.2f)", sensetivity$TE.random.w*100, sensetivity$lower.random.w*100, sensetivity$upper.random.w*100,sensetivity$I2.w,sensetivity$lower.I2.w,sensetivity$upper.I2.w)
df_sgp$"Weight" <- round(sensetivity$w.random.w*100/sum(sensetivity$w.random.w),2)
df_sgp$"Specificity (95%CI)" <- sprintf("%.2f (%.2f - %.2f)\nI^2 = %.2f (%.2f - %.2f)", specificity$TE.random.w*100, specificity$lower.random.w*100, specificity$upper.random.w*100,specificity$I2.w,specificity$lower.I2.w,specificity$upper.I2.w)
df_sgp$" Weight" <- round(specificity$w.random.w*100/sum(specificity$w.random.w),2)
df_sgp$"AI model" <- ""
df_sgp$lesion <- ""
df_sgp$modality <- ""
df_sgp$dataset <- ""

# df_sgp
```
```{r summary_row}
# //STUB - add summary measures
df_plot_sum <- data.frame(
    Study = "Total",
    sen = sensetivity$TE.random,
    sen_low = sensetivity$lower.random,
    sen_hi = sensetivity$upper.random,
    Sensetivity = paste(rep(" ",15),collapse = " "),
    spe = specificity$TE.random,
    spe_low = specificity$lower.random,
    spe_hi = specificity$upper.random,
    Specificity = paste(rep(" ",15),collapse = " ")
)
df_plot_sum$"Sensetivity (95%CI)" <- paste(sprintf("%.2f (%.2f - %.2f)", sensetivity$TE.random*100, sensetivity$lower.random*100, sensetivity$upper.random*100),"\ntau^2 = 0.0128 [0.0080; 0.0469]\nI^2 = 87.0% [81.4%; 91.0%]")
df_plot_sum$"Weight" <- ""
df_plot_sum$"Specificity (95%CI)" <- paste(sprintf("%.2f (%.2f - %.2f)", specificity$TE.random*100, specificity$lower.random*100, specificity$upper.random*100),"\ntau^2 = 0.0017 [0.0010; 0.0089]\nI^2 = 90.9% [87.3%; 93.4%]")
df_plot_sum$" Weight" <- ""
df_plot_sum$"AI model" <- ""
df_plot_sum$lesion <- ""
df_plot_sum$modality <- ""
df_plot_sum$dataset <- ""

df_plot <- df_plot %>% rbind(df_sgp) %>% rbind(df_plot_sum)
# View(df_plot)

# colnames(df_plot)
# head(df_diag)
```

```{r forest_plots}
library(forestploter)

p <- forestploter::forest(
    df_plot[,c(1,15,14,10,11,5,12,13,9,16,17)],
    est = list(df_plot$sen,df_plot$spe),
    lower = list(df_plot$sen_low,df_plot$spe_low),
    upper = list(df_plot$sen_hi,df_plot$spe_hi),
    xlim = c(.4,1),
    ticks_at = c(.4,.6,.8,1),
    ref_line = c(sensetivity$TE.random,specificity$TE.random),
    ci_column = c(6,9),
    is_summary = c(rep(FALSE,dim(df_plot)[1]-4),rep(TRUE,4)),
    title = "Sensetivity and Specificity of AI models in diagnosis of shoiulder lesions using MRI\n"
)

p <- add_border(
    p,
    row = c(6,14,40,43),
    col = NULL,
    # part = c("body", "header"),
    where = c("bottom"),
    gp = gpar(lwd = 2)
)

plot(p)
```